<!DOCTYPE html>
<html>
    <head>
	<title>B.A.S.E.L. ERNI Global Hackaton 2023 Robot Interface</title>
        <link href="styles.css" rel="stylesheet">
    </head>
    <body>
    <div class="header">
        <img src="images/erni-logo.svg" alt="" style="width: 140px; height: 70px">
        <div class="header-text-container">
            <div class="header-text" style="margin-left: 40px">Hackathon 2023</div>
            <img src="images/code-logo.svg" alt="" style="width: 120px; height: 60px">
            <div class="header-text">Team B.A.S.E.L</div>
        </div>
        <div class="github-container" onclick="openGitHubRepo()">
            <div class="github-text">GitHub-Repository</div>
            <img src="images/github-logo.svg" alt="" style="width: 40px; height: 40px">
        </div>
        <script>
            function openGitHubRepo() {
                parent.open("https://github.com/ERNICommunity/HackathonTeamBASEL.git")
            }
        </script>
    </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
        <script>
            // Create a client instance
            client = new Paho.MQTT.Client( window.location.host, 9001, "webid");

            // set callback handlers
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            // connect the client
            client.connect({onSuccess:onConnect});

            // called when the client connects
            function onConnect() {
                // Once a connection has been made, make a subscription and send a message.
                console.log("onConnect");
                client.subscribe("state");
            }

            // called when the client loses its connection
            function onConnectionLost(responseObject) {
                if (responseObject.errorCode !== 0) {
                    console.log( "onConnectionLost:" + responseObject.errorMessage);
                }
            }

            // called when a message arrives
            function onMessageArrived(message) {
                console.log( "onMessageArrived:" + message.payloadString);
            }
        </script>

<!--        <img src="http://4.221.188.68:9000/mjpg"></img>-->
<!--        <video data-dashjs-player autoplay src="http://4.221.188.68/live/picamera.mpd" controls></video>-->
        <video id="video1" controls="controls"></video>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                var player;
                var MPD = 'http://4.221.188.68/live/picamera.mpd';
                // var MPD = 'https://dash.akamaized.net/envivio/EnvivioDash3/manifest.mpd';
                var settings = {
                    streaming: {
                        delay: {
                            liveDelay: 0
                        },
                        liveCatchup: {
                            enabled: true
                        }
                    }
                }

                var video = document.querySelector('#video1');
                player = dashjs.MediaPlayer().create();
                player.initialize(video, MPD, true);
                player.updateSettings(settings);
            });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dashjs/4.7.1/dash.all.min.js"></script>
        <div class="slidecontainer">
            <label>Direction</label>
            <input type="range" min="-30" max="30" value="0" class="slider" id="angle0">
            <label>Speed</label>
            <input type="range" min="-50" max="50" value="0" class="slider" id="angle1">
            <label>Rotate Head</label>
            <input type="range" min="-45" max="45" value="0" class="slider" id="angle2">
            <label>Tilt Head</label>
            <input type="range" min="-45" max="45" value="0" class="slider" id="angle3">
        </div>
        <div class="tts"><input id="ttstext" type="text"><input id="ttsbutton" type="button" value="Say"></div>
        <script>
            let angle0 = document.getElementById('angle0');
            let angle1 = document.getElementById('angle1');
            let angle2 = document.getElementById('angle2');
            let angle3 = document.getElementById('angle3');
            let ttstext = document.getElementById('ttstext');
            let ttsbutton = document.getElementById('ttsbutton');

            document.addEventListener('keydown', (event) => {
                let directionCommand;
                let SpeedCommand;

                if (event.key === "ArrowUp") {
                    angle1.value = 50;

                    SpeedCommand = [{
                        "operation" : "set_speed",
                        "speed" : Number( 50)
                    }];

                    sendCommands( SpeedCommand);
                } else if (event.key === "ArrowDown") {
                    angle1.value = -50;

                    SpeedCommand = [{
                        "operation" : "set_speed",
                        "speed" : Number( -50)
                    }];

                    sendCommands( SpeedCommand);
                } else if (event.key === "w") {
                    angle1.value = 50;

                    SpeedCommand = [{
                        "operation" : "set_speed",
                        "speed" : Number( 100)
                    }];

                    sendCommands( SpeedCommand);
                } else if (event.key === "ArrowRight") {
                    angle0.value = 30;

                    directionCommand = [{
                        "operation" : "set_direction",
                        "angle" : Number( 30)
                    }];

                    sendCommands( directionCommand);
                } else if (event.key === "ArrowLeft") {
                    angle0.value = -30;

                    directionCommand = [{
                        "operation" : "set_direction",
                        "angle" : Number( -30)
                    }];

                    sendCommands( directionCommand);
                } else if (event.key === "Enter") {
                    if (ttstext.value.length !== 0) {
                        say();
                    }
                }
            })

            document.addEventListener('keyup', (event) => {
                let directionCommand = [{
                    "operation" : "set_direction",
                    "angle" : Number( 0)
                }];

                let SpeedCommand = [{
                    "operation" : "set_speed",
                    "speed" : Number( 0)
                }];

                if (event.key === "ArrowUp") {
                    angle1.value = 0;
                    sendCommands( SpeedCommand);
                } else if (event.key === "w") {
                    angle1.value = 0;
                    sendCommands( SpeedCommand);
                } else if (event.key === "ArrowDown") {
                    angle1.value = 0;
                    sendCommands( SpeedCommand);
                } else if (event.key === "ArrowRight") {
                    angle0.value = 0;
                    sendCommands( directionCommand);
                } else if (event.key === "ArrowLeft") {
                    angle0.value = 0;
                    sendCommands( directionCommand);
                }
            })

            function onDirectionChanged() {
                var command = [{
                    "operation" : "set_direction",
                    "angle" : Number( angle0.value)
                }];

                sendCommands( command);
            }

            function onSpeedChanged() {
                var command = [{
                    "operation" : "set_speed",
                    "speed" : Number( angle1.value)
                }];

                sendCommands( command);
            }

            function onHeadRotate() {
                var command = [{
                    "operation" : "set_head_rotate",
                    "angle" : Number( angle2.value)
                }];

                sendCommands( command);
            }

            function onHeadTilt() {
                var command = [{
                    "operation" : "set_head_tilt",
                    "angle" : Number( angle3.value)
                }];

                sendCommands( command);
            }

            function say() {
                var command = [{
                    "operation" : "say",
                    "text" : ttstext.value
                }];

                ttstext.value = "";

                sendCommands( command);
            }

            function sendCommands( command) {
                var json = JSON.stringify( command);
                console.log( "Message : " + json);

                message = new Paho.MQTT.Message( json);
                message.destinationName = "command";

                client.send( message);
            }

            angle0.oninput = onDirectionChanged;
            angle1.oninput = onSpeedChanged;
            angle2.oninput = onHeadRotate;
            angle3.oninput = onHeadTilt;

            ttsbutton.onclick = say;
         </script>
    </body>
</html>
